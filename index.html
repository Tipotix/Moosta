<!doctype html>
<html>
    <head>
        <title>Socket.IO chat</title>

        <script src="/socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
        <script>
            let socket = io.connect('http://localhost:3000');
            let isTyping = false;
            let timeOut = undefined;
            
            name = window.prompt('Votre pseudo si vous plait!');
            
            if (name == null)
                $("body").alert('Veuillez rafraichir la page!');

            const timeoutFunction = _ => {
                isTyping = false;
                socket.emit('typing', {
                    name : name,
                    isTyping : false
                });
            }
            
            const isUserTyping = _ => {
                if (isTyping === false && $('#msg').is(':focus')) {
                    isTyping = true;
                    let data = {
                        name : name,
                        isTyping : true
                    };
                    socket.emit('typing', data);
                } else {
                    clearTimeout(timeout);
                    timeout = setTimeout(timeoutFunction, 5000);
                }
            }

            socket.on('typing', data => {
                if (data.isTyping) {
                    $('#status').append("<li id='"+ data.name +"'><small>" + data.name + " est en train d'Ã©crire...</small></li>");
                    timeout = setTimeout(timeoutFunction, 1500);
                }
                else {
                    $('#' + data.name + '').remove();
                }
            });

            socket.on('chatMessage', data => {
                $('#messages')
                    .append($('<li>')
                    .append($('<b>')
                        .text(data.name)
                    .append('<strong>:</strong>')
                    .append($('</b>')))

                    .append(data.msg));
            });

            const sendMessage = _ => {
                socket.emit('chatMessage', {
                    name: name,
                    msg: $('#msg').val()
                });
                
                $('#msg').val('');
            }

            window.onload = () => {
                $('#user-name').html(name);
            }
        </script>
    </head>

    <body>
    <div class="chatbox">
        <div id="chat-header">
            <div id="user-name"></div>
            <div id="chat-options"></div>
        </div>
        <ul id="status"></ul>
        <ul id="messages" class="bubble"></ul>
    </div>
    <input id="msg" autocomplete="off" onkeypress = "isUserTyping()"/><button id="send" onclick="sendMessage()">Send</button>
    </body>
</html>